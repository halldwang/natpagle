<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>简介 | JavaScript中的函数式编程</title>
    <meta name="description" content="JavaScript 中的函数式编程">
    
    
    <link rel="preload" href="/natpagle/assets/css/0.styles.704ec6d9.css" as="style"><link rel="preload" href="/natpagle/assets/js/app.b21d4d52.js" as="script"><link rel="preload" href="/natpagle/assets/js/2.793adf42.js" as="script"><link rel="preload" href="/natpagle/assets/js/7.e166f63b.js" as="script"><link rel="prefetch" href="/natpagle/assets/js/10.bb99e574.js"><link rel="prefetch" href="/natpagle/assets/js/11.8cce9fd8.js"><link rel="prefetch" href="/natpagle/assets/js/12.f3ea115a.js"><link rel="prefetch" href="/natpagle/assets/js/13.fe574bc4.js"><link rel="prefetch" href="/natpagle/assets/js/14.752b3757.js"><link rel="prefetch" href="/natpagle/assets/js/15.6a578eca.js"><link rel="prefetch" href="/natpagle/assets/js/16.44463992.js"><link rel="prefetch" href="/natpagle/assets/js/3.1f46a39d.js"><link rel="prefetch" href="/natpagle/assets/js/4.832153c4.js"><link rel="prefetch" href="/natpagle/assets/js/5.d5389a0e.js"><link rel="prefetch" href="/natpagle/assets/js/6.4fa878bd.js"><link rel="prefetch" href="/natpagle/assets/js/8.de7b36b8.js"><link rel="prefetch" href="/natpagle/assets/js/9.d3b39cee.js">
    <link rel="stylesheet" href="/natpagle/assets/css/0.styles.704ec6d9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/natpagle/" class="home-link router-link-active"><!----> <span class="site-name">JavaScript中的函数式编程</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/natpagle/" class="nav-link">首页</a></div><div class="nav-item"><a href="/natpagle/book/cover-preface.html" class="nav-link">章节</a></div><div class="nav-item"><a href="/natpagle/book/contribution.html" class="nav-link">贡献内容</a></div> <a href="https://github.com/halldwang/natpagle" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/natpagle/" class="nav-link">首页</a></div><div class="nav-item"><a href="/natpagle/book/cover-preface.html" class="nav-link">章节</a></div><div class="nav-item"><a href="/natpagle/book/contribution.html" class="nav-link">贡献内容</a></div> <a href="https://github.com/halldwang/natpagle" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/natpagle/book/cover-preface.html" class="sidebar-link">章节和目录</a></li><li><a href="/natpagle/book/chapter-first.html" class="sidebar-link">第一章：通过一个案例了解JavaScript语言能力</a></li><li><a href="/natpagle/book/chapter-second.html" class="sidebar-link">第二章：函数式编程基础</a></li><li><a href="/natpagle/book/chapter-third.html" class="sidebar-link">第三章：搭建函数式编程环境</a></li><li><a href="/natpagle/book/chapter-fourth.html" class="sidebar-link">第四章：JavaScript中的函数式编程实现</a></li><li><a href="/natpagle/book/chapter-fifth.html" class="active sidebar-link">第五章：理论范畴</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/natpagle/book/chapter-fifth.html#范畴论" class="sidebar-link">范畴论</a></li><li class="sidebar-sub-header"><a href="/natpagle/book/chapter-fifth.html#类型安全" class="sidebar-link">类型安全</a></li><li class="sidebar-sub-header"><a href="/natpagle/book/chapter-fifth.html#对象标识" class="sidebar-link">对象标识</a></li><li class="sidebar-sub-header"><a href="/natpagle/book/chapter-fifth.html#函子" class="sidebar-link">函子</a></li><li class="sidebar-sub-header"><a href="/natpagle/book/chapter-fifth.html#回顾函数组合" class="sidebar-link">回顾函数组合</a></li><li class="sidebar-sub-header"><a href="/natpagle/book/chapter-fifth.html#monads" class="sidebar-link">Monads</a></li><li class="sidebar-sub-header"><a href="/natpagle/book/chapter-fifth.html#promises" class="sidebar-link">Promises</a></li><li class="sidebar-sub-header"><a href="/natpagle/book/chapter-fifth.html#lenses" class="sidebar-link">Lenses</a></li><li class="sidebar-sub-header"><a href="/natpagle/book/chapter-fifth.html#jquery是一个monad" class="sidebar-link">jQuery是一个monad</a></li><li class="sidebar-sub-header"><a href="/natpagle/book/chapter-fifth.html#功能实现" class="sidebar-link">功能实现</a></li><li class="sidebar-sub-header"><a href="/natpagle/book/chapter-fifth.html#小结" class="sidebar-link">小结</a></li></ul></li><li><a href="/natpagle/book/chapter-sixth.html" class="sidebar-link">第六章：JavaScript中的高级函数和陷阱话题</a></li><li><a href="/natpagle/book/chapter-seventh.html" class="sidebar-link">第七章：JavaScript中的函数式和面向对象编程</a></li><li><a href="/natpagle/book/appendix.html" class="sidebar-link">附录：JavaScript中常用函数的函数式方法</a></li><li><a href="/natpagle/book/contribution.html" class="sidebar-link">贡献内容</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="简介"><a href="#简介" class="header-anchor">#</a> 简介</h1> <p>托马斯·沃森（Thomas Watson）曾有一句名言：“我认为世界上可能有五台电脑的市场。”。那是在1948年。那时，每个人都知道计算机只能用于两件事：数学和工程学。即使是科技界最有头脑的人也无法预测，有一天，计算机将能够把西班牙语翻译成英语，或者模拟整个天气系统。当时，最快的机器是IBM的SSEC，每秒50次乘法，多个用户终端共享一个处理器。晶体管改变了一切，但科技公司的远见者仍然没有达到目标。肯·奥尔森（Ken Olson）在1977年做出了另一个著名的愚蠢预测，当时他说“没有理由任何人想要在家里有一台电脑”。</p> <p>当今，计算机不仅仅是为科学家和工程师服务的，70年前，认为机器不仅仅能做数学的想法根本不是直觉。沃森没有意识到计算机是如何改变一个社会的，他也没有意识到数学的变革和进化的力量。</p> <p>但并不是每个人都忽视了计算机和数学的潜力。John McCarthy在1958年发明了Lisp，这是一种革命性的基于算法的语言，开创了计算的新纪元。从一开始，Lisp就在使用抽象层-编译器、解释器、虚拟化-来推动计算机从核心数学机器发展到今天的发展方面发挥了重要作用。</p> <p>Lisp衍生的Scheme是JavaScript的语言祖先。现在我们又回到了原点。如果计算机的核心是只做数学运算的机器，那么基于数学的编程范例理所当然会出类拔萃。</p> <p>这里使用的术语“数学”不是用来描述计算机显然能做的“数字运算”，而是用来描述离散数学：研究离散的数学结构，如逻辑中的语句或计算机语言的指令。通过将代码视为一种离散的数学结构，我们可以将数学中的概念和思想应用到代码中。这就是函数式编程在人工智能、图形搜索、模式识别和计算机科学中的其他重大挑战中发挥如此重要作用的原因。</p> <p>在本章中，我们将试验其中一些概念及其在日常编程挑战中的应用。它们将包括：</p> <ul><li>Category theory 范畴论</li> <li>Morphisms 态射</li> <li>Functors 函子</li> <li>Maybes</li> <li>Promises</li> <li>lenses 状态管理（依赖）<a href="https://blog.csdn.net/weixin_34032792/article/details/87963097" target="_blank" rel="noopener noreferrer">原理<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>Function composition 函数组合</li></ul> <p>有了这些概念，才能够非常容易和安全地编写函数库和api。我们将从解释范畴理论到用JavaScript正式实现它。</p> <h2 id="范畴论"><a href="#范畴论" class="header-anchor">#</a> 范畴论</h2> <p>范畴理论是赋予功能构成权力的理论概念。（此处有删减，举例：<a href="https://blog.csdn.net/weixin_43801661/article/details/84670359" target="_blank" rel="noopener noreferrer">让你烤个面包<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。）</p> <h3 id="范畴论简述"><a href="#范畴论简述" class="header-anchor">#</a> 范畴论简述</h3> <p>范畴论不是一个很难的概念。 它在数学上的位置足以填满整个研究生水平的大学课程，但是在计算机编程中的位置可以很容易地总结出来。</p> <p>爱因斯坦曾经说过，“如果你不能向一个6岁的孩子解释它，那么你自己也不清楚”。因此，本着向6岁儿童解释的精神，范畴理论只是把这些点联系起来。尽管它可能过于简化范畴理论，但它确实很好地以一种直截了当的方式解释了我们需要知道的东西。</p> <p>首先你需要知道一些术语。类别只是具有相同类型的集合。在JavaScript中，它们是数组或对象，包含显式声明为数字、字符串、布尔值、日期、节点等的变量。态射是纯函数，当给定一组特定的输入时，总是返回相同的输出。同态操作仅限于一个类别，而多态操作可以操作多个类别。例如，同态函数乘法适用于数字类型，但多态函数加法也可以对字符串起作用。</p> <p><img src="https://blog.ahthw.com/wp-content/uploads/2019/12/f8b.png" alt="img"></p> <p>下图显示了三个类别-A、B和C-以及两个态射-ƒ和ɡ。
范畴理论告诉我们，当我们有两个态射，其中第一个态射的范畴是另一个态射的期望输入时，它们可以组成如下：</p> <p><img src="https://blog.ahthw.com/wp-content/uploads/2019/12/1577544451533.jpg" alt="img"></p> <p>ƒog 符号是同态ƒ和g的组合。现在我们只需要把点连接起来。</p> <p><img src="https://blog.ahthw.com/wp-content/uploads/2019/12/1577545148359.jpg" alt="img"></p> <p>只是连接点而已，仅此而已。</p> <h2 id="类型安全"><a href="#类型安全" class="header-anchor">#</a> 类型安全</h2> <p>让我们把这些点连起来。包含两个内容：</p> <ol><li>Objects对象（在JavaScript中，types）。</li> <li>Morphisms态射（在JavaScript中，仅适用于纯函数的类型）。</li></ol> <p>这些是数学家给范畴理论的术语，因此我们的JavaScript术语中有一些不幸的术语重载。范畴理论中的对象更像是具有显式数据类型的变量，而不是JavaScript定义的对象属性和值集合。形态只是使用这些类型的纯函数。</p> <p>因此，将范畴理论的思想应用于JavaScript很容易。在JavaScript中使用范畴理论意味着在每个范畴中使用一种特定的数据类型。数据类型包括数字、字符串、数组、日期、对象、布尔值等。但是，由于JavaScript中没有严格的类型系统，可能会出错。所以我们必须自己实现方法来确保数据正确。</p> <p>JavaScript中有四种基本数据类型：数字、字符串、布尔值和函数。我们可以创建返回变量或抛出错误的类型安全函数。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">str</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">s</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> s <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">&quot;Error: String expected, &quot;</span> <span class="token operator">+</span> <span class="token keyword">typeof</span> s <span class="token operator">+</span> <span class="token string">&quot;given.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token function-variable function">num</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> n <span class="token operator">===</span> <span class="token string">&quot;number&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> n<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">&quot;Error: Number expected, &quot;</span> <span class="token operator">+</span> <span class="token keyword">typeof</span> n <span class="token operator">+</span> <span class="token string">&quot;given.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token function-variable function">bool</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> b <span class="token operator">===</span> <span class="token string">&quot;boolean&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> b<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">&quot;Error: Boolean expected, &quot;</span> <span class="token operator">+</span> <span class="token keyword">typeof</span> b <span class="token operator">+</span> <span class="token string">&quot;given.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token function-variable function">func</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> f <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> f<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">&quot;Error: Function expected, &quot;</span> <span class="token operator">+</span> <span class="token keyword">typeof</span> f <span class="token operator">+</span> <span class="token string">&quot; given.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>虽然以上有很多重复的代码，但它们的功满足需要。 相反，我们可以创建一个函数，该函数返回另一个函数，即类型安全函数。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">typeOf</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> x <span class="token operator">===</span> type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> x<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span>
        <span class="token string">&quot;Error: &quot;</span> <span class="token operator">+</span> type <span class="token operator">+</span> <span class="token string">&quot; expected, &quot;</span> <span class="token operator">+</span> <span class="token keyword">typeof</span> x <span class="token operator">+</span> <span class="token string">&quot;given.&quot;</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token function">typeOf</span><span class="token punctuation">(</span><span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  num <span class="token operator">=</span> <span class="token function">typeOf</span><span class="token punctuation">(</span><span class="token string">&quot;number&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  func <span class="token operator">=</span> <span class="token function">typeOf</span><span class="token punctuation">(</span><span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  bool <span class="token operator">=</span> <span class="token function">typeOf</span><span class="token punctuation">(</span><span class="token string">&quot;boolean&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>我们使用它们来确保我们的函数按预期运行。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// unprotected method:</span>
<span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token string">&quot;24&quot;</span><span class="token punctuation">;</span>
x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// will return '241', not 25</span>
<span class="token comment">// protected method</span>
<span class="token comment">// plusplus :: Int -&gt; Int</span>
<span class="token keyword">function</span> <span class="token function">plusplus</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">num</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">plusplus</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// throws error, preferred over unexpected output</span>
</code></pre></div><p>让我们看一个更重要的例子。 如果要检查由JavaScript函数Date.parse()返回的Unix时间戳的长度，不是字符串，而是数字，则必须使用str()函数。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// timestampLength :: String -&gt; Int</span>
<span class="token keyword">function</span> <span class="token function">timestampLength</span><span class="token punctuation">(</span><span class="token parameter">t</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">num</span><span class="token punctuation">(</span><span class="token function">str</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">timestampLength</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">&quot;12/31/1999&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// throws error</span>
<span class="token function">timestampLength</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">&quot;12/31/1999&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// returns 12</span>
</code></pre></div><p>像这样显式地将一种类型转换为另一种类型（或同一类型）的函数称为态射。这满足了范畴论的态射公理。这些通过类型安全性函数的强制类型声明以及使用它们的态射是我们在JavaScript中表示类别概念所需要的一切。</p> <h2 id="对象标识"><a href="#对象标识" class="header-anchor">#</a> 对象标识</h2> <p>还有一种重要的数据类型：对象。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token function">typeOf</span><span class="token punctuation">(</span><span class="token string">&quot;object&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">obj</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// throws error</span>
<span class="token function">obj</span><span class="token punctuation">(</span><span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token string">&quot;a&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// returns {x:'a'}</span>
</code></pre></div><p>但是，对象是不同的。它们可以继承。并非原语的所有内容（数字，字符串，布尔值和函数）都是一个对象，包括数组，日期，元素等。</p> <p>我们无法从<code>typeof</code>关键字中知道某个对象是什么类型的，比如从typeof关键字中知道JavaScript“object”是什么子类型，所以我们必须想其它办法。对象有一个toString()函数，我们可以的劫持它。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">obj</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">o</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&quot;[object Object]&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> o<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">&quot;Error: Object expected, something else given.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>在所有对象都存在的情况下，我们应该实现一些代码复用。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">objectTypeOf</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">o</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&quot;[object &quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> o<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">&quot;Error: '+name+' expected, something else given.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token function">objectTypeOf</span><span class="token punctuation">(</span><span class="token string">&quot;Object&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token function">objectTypeOf</span><span class="token punctuation">(</span><span class="token string">&quot;Array&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> date <span class="token operator">=</span> <span class="token function">objectTypeOf</span><span class="token punctuation">(</span><span class="token string">&quot;Date&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> div <span class="token operator">=</span> <span class="token function">objectTypeOf</span><span class="token punctuation">(</span><span class="token string">&quot;HTMLDivElement&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>以上对于我们的下一个主题：函子将非常有用。</p> <h2 id="函子"><a href="#函子" class="header-anchor">#</a> 函子</h2> <p>态射是类型之间的映射，函子是类别之间的映射。 可以将它们视为将值从容器中取出，变形然后再将其放入新容器中的函数。 第一个输入是该类型的词素，第二个输入是容器。</p> <blockquote><p>函子的类型签名如：// myFunctor ::（a-&gt; b）-&gt; f a-&gt; f b 这就是说，“给我一个接受a并返回b和包含a(s)的box的函数，然后我将返回包含b(s)的box。</p></blockquote> <h3 id="创建函子"><a href="#创建函子" class="header-anchor">#</a> 创建函子</h3> <p>事实证明，我们已经有一个函子：map()。 它获取容器，数组中的值，并对其应用函数。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span>sqrt<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Returns: [1, 2, 3]</span>
</code></pre></div><p>但是，我们需要将其编写为全局函数，而不是数组对象的方法。 这将使我们以后可以编写更干净，更安全的代码。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// map :: (a -&gt; b) -&gt; [a] -&gt; [b]</span>
<span class="token keyword">var</span> <span class="token function-variable function">map</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">f<span class="token punctuation">,</span> a</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">arr</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token function">func</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>这个例子看起来像是一个设计的包装器，因为我们只是搭载在map()函数上。但这是有目的的。它为其他类型的映射提供模板。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// strmap :: (str -&gt; str) -&gt; str -&gt; str</span>
<span class="token keyword">var</span> <span class="token function-variable function">strmap</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">f<span class="token punctuation">,</span> s</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">return</span> <span class="token function">str</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token function">func</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// MyObject#map :: (myValue -&gt; a) -&gt; a</span>
<span class="token class-name">MyObject</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>f<span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">func</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>myValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="数组和函子"><a href="#数组和函子" class="header-anchor">#</a> 数组和函子</h3> <p>数组是在函数式JavaScript中处理数据的首选方法。</p> <p>有没有一种更简单的方法来创建已经分配给态射的函子？是的，它叫arrayOf。当你传入一个期望整数的态射并返回一个数组时，你得到一个期望整数数组的态射并返回一个数组数组。</p> <p>它本身不是函子，但它使我们能够根据态射来创建函子。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// arrayOf :: (a -&gt; b) -&gt; ([a] -&gt; [b])</span>
<span class="token keyword">var</span> <span class="token function-variable function">arrayOf</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token function">func</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>这是通过使用态射来创建函子的方法：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> plusplusall <span class="token operator">=</span> <span class="token function">arrayOf</span><span class="token punctuation">(</span>plusplus<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// plusplus is our morphism</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">plusplusall</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// returns [2,3,4]</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">plusplusall</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// error is thrown</span>
</code></pre></div><p>arrayOf函数的有趣之处在于它也可以处理类型安全性。 当为字符串传递类型安全函数时，将返回字符串数组的类型安全函数。 类型安全性像身份函数态射一样对待。 这为数组包含所有正确的类型提供了方式。</p> <h2 id="回顾函数组合"><a href="#回顾函数组合" class="header-anchor">#</a> 回顾函数组合</h2> <p>函数是我们可以为其创建函子的另一种原语。 该函子称为<code>fcompose</code>。我们将函子定义为从容器中获取值并对其应用函数的对象。 当该容器是一个函数时，我们只需调用它即可获取其内部值。</p> <p>我们已经知道什么是函数组合，但是让我们看看它们在范畴理论驱动的环境中可以做什么。</p> <p>函数组合是关联的。如果你的高中代数老师和我一样，教你什么是属性，而不是它能做什么。实际上，组合是关联的属性所能做的事情。</p> <p><img src="https://blog.ahthw.com/wp-content/uploads/2019/12/WX20191229-230353@2x.png" alt="img"></p> <p>我们可以进行任何内部组合，无论如何组合。 请勿将此与可交换属性混淆。ƒ o g并不总是等于g o ƒ。换言之，字符串的第一个单词的反义词与字符串的第一个单词的反义词不同。</p> <p>这一切意味着，只要每个函数的输入来自前一个函数的输出，那么应用哪个函数和以什么顺序无关紧要。但是，如果右边的函数依赖左边的函数，那么就不能只有一个求值顺序吗？从左到右？但是如果将其封装起来，那么我们可以把控它，不管我们感觉如何。这就是在JavaScript中惰性计算的原因。</p> <p><img src="https://blog.ahthw.com/wp-content/uploads/2019/12/8027-86964e9a39d1.png" alt="img"></p> <p>让我们重写函数组成，而不是作为函数原型的扩展，而是作为一个独立的函数，它将使我们受益匪浅。 基本形式如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">fcompose</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">f<span class="token punctuation">,</span> g</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">g</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>但我们需要它来处理任意数量的实参。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">fcompose</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// first make sure all arguments are functions</span>
  <span class="token keyword">var</span> funcs <span class="token operator">=</span> <span class="token function">arrayOf</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// return a function that applies all the functions</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> argsOfFuncs <span class="token operator">=</span> arguments<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> funcs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      argsOfFuncs <span class="token operator">=</span> <span class="token punctuation">[</span>funcs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// example:</span>
<span class="token keyword">var</span> f <span class="token operator">=</span> <span class="token function">fcompose</span><span class="token punctuation">(</span>negate<span class="token punctuation">,</span> square<span class="token punctuation">,</span> mult2<span class="token punctuation">,</span> add1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">f</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Returns: -36</span>
</code></pre></div><p>既然我们已经封装了这些函数，我们就可以控制它们了。我们可以重写compose函数，以便每个函数接受另一个函数作为输入，存储它，并返回一个执行相同操作的对象。我们可以接受源中每个元素的一个数组，执行组合的所有操作（每个map()、filter()等等，组合在一起），最后将结果存储到一个新数组中，而不是接受一个数组作为输入，对它执行一些操作，然后为每个操作返回一个新数组。这是通过函数组合的惰性求值。没有理由在这里重新发明轮子。许多库都很好地实现了这个概念，包括Lazy.js、Bacon.js和wu.js库。</p> <p>由于采用了这种不同的模型，我们可以做更多的事情：异步迭代，异步事件处理，惰性求值，甚至自动并行化。</p> <p><code>自动并行化？在计算机科学界有一个说法：不可能。但这真的不可能吗？摩尔定律的下一个进化飞跃可能是一个编译器，它可以为我们并行化代码，函数组合也可以吗？不，这样不太管用。JavaScript引擎实际上是在进行并行化，不是自动的，而是经过深思熟虑的代码。Compose只是让引擎有机会将其拆分为并行进程。但这本身就很酷。</code></p> <h2 id="monads"><a href="#monads" class="header-anchor">#</a> Monads</h2> <p>Monad是可帮助您编写功能的工具。</p> <p>与基本类型一样，monad是可以用作函子“触及”的容器的结构。函子抓取数据，对其进行处理，将其放入一个新的monad中，然后返回。</p> <p>我们将关注三个monad：</p> <ul><li>Maybes</li> <li>Promises</li> <li>Lenses</li></ul> <p>所以除了数组（map）和函数（compose），我们还有五个函子（map，compose，may，promise和lens）。这些只是许多其他函子和单子中的一部分。</p> <h3 id="maybes"><a href="#maybes" class="header-anchor">#</a> Maybes</h3> <p>Maybes允许我们优雅地处理可能为空并具有默认值的数据。maybe是一个变量，它要么有一些值要么没有，对调用者来说无关紧要。</p> <p>就其本身而言，这似乎没什么大不了的。大家都知道，使用if-else语句很容易完成空检查：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  username <span class="token operator">=</span> <span class="token string">&quot;Anonymous&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  username <span class="token operator">=</span> <span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>但是在函数式编程中，我们脱离了逐行处理方式，而是使用函数和数据的管道。如果我们必须在中间断开链来检查值是否存在，我们就必须创建临时变量并编写更多代码。Maybes是帮助我们保持逻辑在管道中流动的工具。</p> <p>要实现Maybes，我们首先需要创建一些构造函数。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// the Maybe monad constructor, empty for now</span>
<span class="token keyword">var</span> <span class="token function-variable function">Maybe</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// the None instance, a wrapper for an object with no value</span>
<span class="token keyword">var</span> <span class="token function-variable function">None</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">None</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Maybe</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">None</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">toString</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">&quot;None&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// now we can write the `none` function</span>
<span class="token comment">// saves us from having to write `new None()` all the time</span>
<span class="token keyword">var</span> <span class="token function-variable function">none</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">None</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// and the Just instance, a wrapper for an object with a value</span>
<span class="token keyword">var</span> <span class="token function-variable function">Just</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">Just</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Maybe</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Just</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">toString</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">&quot;Just &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token function-variable function">just</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Just</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>我们可以编写maybe函数。它返回一个新函数，该函数要么不返回任何内容，要么返回maybe。</p> <p>它是一个函子：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">maybe</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">m</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token keyword">instanceof</span> <span class="token class-name">None</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> m<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token keyword">instanceof</span> <span class="token class-name">Just</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">just</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span>
      <span class="token string">&quot;Error: Just or None expected, &quot;</span> <span class="token operator">+</span> m<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; given.&quot;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>我们也可以像创建数组一样创建函子生成器:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">maybeOf</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">m</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token keyword">instanceof</span> <span class="token class-name">None</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> m<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token keyword">instanceof</span> <span class="token class-name">Just</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">just</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span>
        <span class="token string">&quot;Error: Just or None expected, &quot;</span> <span class="token operator">+</span> m<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; given.&quot;</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>所以Maybe是monad，maybe是函子，maybeOf返回已经分配给态射的函子。我们需要向Maybe monad对象添加一个方法，帮助我们更直观地使用它。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">Maybe</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">orElse</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">instanceof</span> <span class="token class-name">Just</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> y<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>在其原型中，maybes可以直接使用。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">maybe</span><span class="token punctuation">(</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span> <span class="token comment">// Returns 123</span>
<span class="token function">maybeOf</span><span class="token punctuation">(</span>plusplus<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span> <span class="token comment">// Returns 124</span>
<span class="token function">maybe</span><span class="token punctuation">(</span>plusplus<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">none</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token string">&quot;none&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// returns 'none'</span>
</code></pre></div><p>任何返回一个随后被执行的方法的操作都非常复杂。所以我们可以通过调用curry()函数使它更简洁一些。</p> <div class="language-js extra-class"><pre class="language-js"><code>maybePlusPlus <span class="token operator">=</span> maybeOf<span class="token punctuation">.</span><span class="token function">curry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>plusplus<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">maybePlusPlus</span><span class="token punctuation">(</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span> <span class="token comment">// returns 123</span>
<span class="token function">maybePlusPlus</span><span class="token punctuation">(</span><span class="token function">none</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token string">&quot;none&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// returns none</span>
</code></pre></div><p>当抽象出直接调用none()和just()函数时，maybes的真正强大就会显露。我们将使用一个示例对象User来实现这一点，该对象使用mays作为用户名。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">User</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>username <span class="token operator">=</span> <span class="token function">none</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// initially set to `none`</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">User</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">setUsername</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>username <span class="token operator">=</span> <span class="token function">just</span><span class="token punctuation">(</span><span class="token function">str</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// it's now a `just</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">User</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">getUsernameMaybe</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> usernameMaybe <span class="token operator">=</span> maybeOf<span class="token punctuation">.</span><span class="token function">curry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">usernameMaybe</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>username<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token string">&quot;anonymous&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
user<span class="token punctuation">.</span><span class="token function">getUsernameMaybe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Returns 'anonymous'</span>
user<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">&quot;Laura&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
user<span class="token punctuation">.</span><span class="token function">getUsernameMaybe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Returns 'Laura'</span>
</code></pre></div><p>我们有了一个强大而安全的方法来定义默认值。记住这个User对象，因为我们将在本章后面使用它。</p> <h2 id="promises"><a href="#promises" class="header-anchor">#</a> Promises</h2> <p><code>承诺的本质是它们不受环境变化的影响。-Frank Underwood，纸牌屋</code></p> <p>在函数式编程中，我们经常使用管道和数据流：函数链，其中每个函数产生的数据类型将被下一个消耗。但是，其中许多函数是异步的：readFile、events、AJAX等。与其使用连续传递样式和深度嵌套的回调，不如如何修改这些函数的返回类型以指示结果？通过将它们包装在promises中。</p> <p>Promises就像是回调的功能等价物。显然，回调不具有全部功能，因为如果有多个函数正在改变相同的数据，则可能存在争用条件和错误。Promises solve能解决这个问题。</p> <p>你应该用Promises来解决它：</p> <div class="language-js extra-class"><pre class="language-js"><code>fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">&quot;file.json&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;unable to read file&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      val <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">.</span>success<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;invalid json in file&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>使用以下代码：</p> <div class="language-js extra-class"><pre class="language-js"><code>fs<span class="token punctuation">.</span><span class="token function">readFileAsync</span><span class="token punctuation">(</span><span class="token string">&quot;file.json&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span>parse<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">.</span>success<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>SyntaxError<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;invalid json in file&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;unable to read file&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>上面的代码来自<a href="https://github.com/petkaantonov/bluebird" target="_blank" rel="noopener noreferrer">bluebird<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的README：一个功能齐全的Promises/a+实现，性能非常好。Promises/A+是用JavaScript实现Promises的规范。(当时考虑到JavaScript社区目前的争论，我们将把实现留给Promises/A+团队，因为它比maybes复杂得多。)</p> <p>但这里有一个实现的片段：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// the Promise monad</span>
<span class="token keyword">var</span> Promise <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;bluebird&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// the promise functor</span>
<span class="token keyword">var</span> <span class="token function-variable function">promise</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> slice <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>slice<span class="token punctuation">,</span>
      args <span class="token operator">=</span> <span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> fn<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    args<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> results <span class="token operator">=</span> <span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">,</span>
        error <span class="token operator">=</span> results<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">else</span> promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> results<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>receiver<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> promise<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>现在，我们可以使用promise()函数将回调函数转换为返回promises的函数。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> files <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;a.json&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;b.json&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;c.json&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
readFileAsync <span class="token operator">=</span> <span class="token function">promise</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span>readFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> data <span class="token operator">=</span> files
  <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">readFileAsync</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span>parse<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> $<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="lenses"><a href="#lenses" class="header-anchor">#</a> Lenses</h2> <p>程序员真正喜欢monad的另一个原因是它们使编写库变得非常容易。为了探索这一点，让我们使用更多的函数来扩展User对象以getting和getting值，但是，我们将使用lenses而不是使用getter和setter。</p> <p>lenses是一流的getter和setter。它们不仅允许我们获取和设置变量，还允许我们在变量上运行函数。但是，它不是对原始数据进行改变，而是克隆并返回由函数修改的新数据。它们迫使数据是不可变的，这对于安全性和一致性以及库都非常有用。无论应用程序是什么，它们都非常适合优雅的代码，引入额外的数组副本对性能的影响不是很大。</p> <p>在编写lens()函数之前，让我们看看它是如何工作的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> first <span class="token operator">=</span> <span class="token function">lens</span><span class="token punctuation">(</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">arr</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// get</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token function">arr</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token comment">// set</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// outputs 1</span>
first<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// outputs [5, 2, 3]</span>
<span class="token keyword">function</span> <span class="token function">tenTimes</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> x <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
first<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span>tenTimes<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// outputs [10,2,3]</span>
</code></pre></div><p>这是lens()函数的工作方式。 它返回定义了get，set和mod的defined.函数。 lens()函数本身就是一个函子。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> lens <span class="token operator">=</span> <span class="token function">fuction</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">get</span><span class="token punctuation">,</span> <span class="token keyword">set</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> <span class="token function-variable function">f</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">get</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  f<span class="token punctuation">.</span><span class="token function-variable function">get</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token keyword">get</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  f<span class="token punctuation">.</span>set <span class="token operator">=</span> <span class="token keyword">set</span><span class="token punctuation">;</span>
  f<span class="token punctuation">.</span><span class="token function-variable function">mod</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">f<span class="token punctuation">,</span> a</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token keyword">set</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token keyword">get</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> f<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>我们来举个例子。我们将在前面的示例中扩展User对象。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// userName :: User -&gt; str</span>
<span class="token keyword">var</span> userName <span class="token operator">=</span> <span class="token function">lens</span><span class="token punctuation">(</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">u</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> u<span class="token punctuation">.</span><span class="token function">getUsernameMaybe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// get</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">u<span class="token punctuation">,</span> v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// set</span>
    u<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> u<span class="token punctuation">.</span><span class="token function">getUsernameMaybe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> bob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
bob<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
userName<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>bob<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// returns 'Bob'</span>
userName<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>bob<span class="token punctuation">,</span> <span class="token string">&quot;Bobby&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//return 'Bobby'</span>
userName<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>bob<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// returns 'Bobby'</span>
userName<span class="token punctuation">.</span><span class="token function">mod</span><span class="token punctuation">(</span>strToUpper<span class="token punctuation">,</span> bob<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// returns 'BOBBY'</span>
strToUpper<span class="token punctuation">.</span><span class="token function">compose</span><span class="token punctuation">(</span>userName<span class="token punctuation">.</span>set<span class="token punctuation">)</span><span class="token punctuation">(</span>bob<span class="token punctuation">,</span> <span class="token string">&quot;robert&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// returns &quot;ROBERT&quot;;</span>
userName<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>bob<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// returns 'robert'</span>
</code></pre></div><h2 id="jquery是一个monad"><a href="#jquery是一个monad" class="header-anchor">#</a> jQuery是一个monad</h2> <p>如果你认为所有这些抽象的关于范畴、函子和单子都没有实际的应用，请考虑一下。 jQuery是流行的JavaScript库，它为使用HTML提供了一个增强的接口，它提供了用于处理HTML的增强接口，它是一个独立的库。</p> <p>jQuery对象是monad，其方法是函子实际上，它们是一种称为endofunctors的特殊函子。 Endofunctors是返回与输入相同类别的函子，即F :: X-&gt;X。每个jQuery方法都接受一个jQuery对象并返回一个jQuery对象，该对象允许方法被链接，并且它们将具有类型签名。jFunc：：jQuery obj-&gt;jQuery obj。</p> <p>这也是jQuery插件框架的功能所在。 如果插件将jQuery对象作为输入并返回一个作为输出，那么可以将其插入链中。</p> <p>monad是函子“接触”以获取数据的容器。 这样，数据可以由库保护和控制。 jQuery通过其许多方法提供对基础数据（包装的HTML元素集）的访问。</p> <p>jQuery对象本身是匿名函数调用的结果。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> jQuery <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> <span class="token function-variable function">j</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">selector<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> jq<span class="token operator">-</span>obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">j<span class="token punctuation">.</span>fn<span class="token punctuation">.</span>init</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> jq<span class="token operator">-</span>obj<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

j<span class="token punctuation">.</span>fn <span class="token operator">=</span> j<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">init</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">selector<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>selector<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

j<span class="token punctuation">.</span>fn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>prototype <span class="token operator">=</span> j<span class="token punctuation">.</span>fn<span class="token punctuation">;</span>
  <span class="token keyword">return</span> j<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在此高度简化的jQuery版本中，它返回定义j对象的函数，该对象实际上只是增强的init构造函数。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> $ <span class="token operator">=</span> <span class="token function">jQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// the function is returned and assigned to `$`</span>
<span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#select-me&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// jQuery object is returned</span>
</code></pre></div><p>就像函子将值从容器中取出一样，jQuery包装HTML元素并提供对它们的访问，而不是直接修改HTML元素。</p> <p>jQuery并不经常公布这一点，但它有自己的map()方法来将HTML元素对象从包装器中取出。 就像fmap()方法一样，元素被提升，对它们进行某些处理，然后将它们放回容器中。 这就是jQuery运行中的许多后台命令工作原理。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;li&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">index<span class="token punctuation">,</span> element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// do something to the element</span>
  <span class="token keyword">return</span> element<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>另一个用于处理HTML元素的库Prototype.js不能像这样工作。Prototype直接通过helpers修改HTML元素。因此，它在JavaScript社区中并没有得到推崇。</p> <h2 id="功能实现"><a href="#功能实现" class="header-anchor">#</a> 功能实现</h2> <p>现在是我们正式将范畴理论定义为JavaScript对象的时候了。 类别是对象（类型）和态射（仅对这些类型起作用的函数）。 这是一种非常高级的，完全声明式的编程方式，它可以确保代码极其安全可靠，对于担心并发性和类型安全性的API和库来说，这是完美的。</p> <p>首先，我们需要一个函数来帮助我们创建态射。 我们将其称为homoMorph（），因为它们将是同态的。 它将返回一个函数，它将返回一个期望传递函数的函数，并根据输入生成该函数的组合。输入是态射接受作为输入并给予作为输出的类型。 就像我们的类型签名一样，即<code>// morph :: num-&gt; num-&gt; [num]</code>，只有最后一个是输出。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">homoMorph</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">/* input1, input2,..., inputN, output */</span>
<span class="token punctuation">{</span>
  <span class="token keyword">var</span> before <span class="token operator">=</span> <span class="token function">checkTypes</span><span class="token punctuation">(</span>
    <span class="token function">arrayOf</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">(</span>
      <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> arguments<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> after <span class="token operator">=</span> <span class="token function">func</span><span class="token punctuation">(</span>arguments<span class="token punctuation">[</span>arguments<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">middle</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">after</span><span class="token punctuation">(</span><span class="token function">middle</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// now we don't need to add type signature comments</span>
<span class="token comment">// because now they're built right into the function declaration</span>
add <span class="token operator">=</span> <span class="token function">homoMorph</span><span class="token punctuation">(</span>
  num<span class="token punctuation">,</span>
  num<span class="token punctuation">,</span>
  num
<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">add</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// returns 36</span>
<span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// throws error</span>
<span class="token function">homoMorph</span><span class="token punctuation">(</span>
  num<span class="token punctuation">,</span>
  num<span class="token punctuation">,</span>
  num
<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// returns 42</span>
</code></pre></div><p>homoMorph()函数非常复杂。 它使用闭包（请参见第2章，函数编程基础）返回一个接受函数并检查其输入和输出值以确保类型安全的函数。 为此，它依赖于一个辅助函数：checkTypes，其定义如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">checkTypes</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">typeSafeties</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">arrayOf</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">arr</span><span class="token punctuation">(</span>typeSafeties<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> argLength <span class="token operator">=</span> typeSafeties<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">arr</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>length <span class="token operator">!=</span> argLength<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">&quot;Expected &quot;</span> <span class="token operator">+</span> argLength <span class="token operator">+</span> <span class="token string">&quot; arguments&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> argLength<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      results<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> typeSafeties<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> results<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>现在让我们正式定义一些同态（homomorphisms）。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> lensHM <span class="token operator">=</span> <span class="token function">homoMorph</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> func<span class="token punctuation">,</span> func<span class="token punctuation">)</span><span class="token punctuation">(</span>lens<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> userNameHM <span class="token operator">=</span> <span class="token function">lensHM</span><span class="token punctuation">(</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">u</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> u<span class="token punctuation">.</span><span class="token function">getUsernameMaybe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// get</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">u<span class="token punctuation">,</span> v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// setu.setUsername(v);</span>
    <span class="token keyword">return</span> u<span class="token punctuation">.</span><span class="token function">getUsernameMaybe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> strToUpperCase <span class="token operator">=</span> <span class="token function">homoMorph</span><span class="token punctuation">(</span>
  str<span class="token punctuation">,</span>
  str
<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">s</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> morphFirstLetter <span class="token operator">=</span> <span class="token function">homoMorph</span><span class="token punctuation">(</span>
  func<span class="token punctuation">,</span>
  str<span class="token punctuation">,</span>
  str
<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">f<span class="token punctuation">,</span> s</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> capFirstLetter <span class="token operator">=</span> <span class="token function">homoMorph</span><span class="token punctuation">(</span>
  str<span class="token punctuation">,</span>
  str
<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">s</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">morphFirstLetter</span><span class="token punctuation">(</span>strToUpperCase<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>最后，我们可以综合下。 以下示例包括函数组和，lens，同态性(homomorphisms)等等。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// homomorphic lenses</span>
<span class="token keyword">var</span> bill <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
userNameHM<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>bill<span class="token punctuation">,</span> <span class="token string">&quot;William&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Returns: 'William'</span>
userNameHM<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>bill<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Returns: 'William'</span>

<span class="token comment">// compose</span>
<span class="token keyword">var</span> capatolizedUsername <span class="token operator">=</span> <span class="token function">fcompose</span><span class="token punctuation">(</span>capFirstLetter<span class="token punctuation">,</span> userNameHM<span class="token punctuation">.</span>get<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">capatolizedUsername</span><span class="token punctuation">(</span>bill<span class="token punctuation">,</span> <span class="token string">&quot;bill&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Returns: 'Bill'</span>

<span class="token comment">// it's a good idea to use homoMorph on .set and .get too</span>
<span class="token keyword">var</span> getUserName <span class="token operator">=</span> <span class="token function">homoMorph</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">(</span>userNameHM<span class="token punctuation">.</span>get<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> setUserName <span class="token operator">=</span> <span class="token function">homoMorph</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> str<span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">(</span>userNameHM<span class="token punctuation">.</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">getUserName</span><span class="token punctuation">(</span>bill<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Returns: 'Bill'</span>
<span class="token function">setUserName</span><span class="token punctuation">(</span>bill<span class="token punctuation">,</span> <span class="token string">&quot;Billy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Returns: 'Billy'</span>

<span class="token comment">// now we can rewrite capatolizeUsername with the new setter</span>
capatolizedUsername <span class="token operator">=</span> <span class="token function">fcompose</span><span class="token punctuation">(</span>capFirstLetter<span class="token punctuation">,</span> setUserName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">capatolizedUsername</span><span class="token punctuation">(</span>bill<span class="token punctuation">,</span> <span class="token string">&quot;will&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Returns: 'Will'</span>
<span class="token function">getUserName</span><span class="token punctuation">(</span>bill<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Returns: 'will'</span>
</code></pre></div><p>以上的代码是非常声明式的，安全的，可靠的。</p> <p><code>代码是声明式的意味着什么？ 在“命令式”编程中，我们编写一系列指令，以告诉机器如何执行所需的操作。 在函数式编程中，我们描述值之间的关系，这些值告诉机器我们要计算的内容，并且机器找出指令序列来实现它。 函数式编程是声明性的。</code></p> <p>整个库和api都可以这样构造，这样程序员就可以自由地编写代码，而不必担心并发性和类型安全，因为这些担心是在后台处理的。</p> <h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <p>大约每2000人中就有一人患有<a href="https://baike.baidu.com/item/%E9%80%9A%E6%84%9F%E7%97%87/1079189" target="_blank" rel="noopener noreferrer">通感症<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，比如说他们在吃好吃的东西的时候，会听到美妙的音乐，听到美妙的音乐会闻到花的香气，绿色可能在他们感觉里是可爱的小熊，难过的情绪对他们来说可能是白色的绵羊。然而，还有一种更为罕见的形式，即句子和段落与品味和感受相关联。</p> <p>对这些人来说，他们不会逐字逐句地解释。他们查看整个页面/文档/程序，了解它的味道不是在嘴里而是在头脑中。然后他们把文本的各个部分像拼图一样拼在一起。</p> <p>这就是编写完全声明性代码的方式：描述值之间关系的代码，这些值告诉机器我们希望它计算什么。 程序的各个部分不是按行顺序排列的指令。 通感学也许能够自然地做到这一点，但是只要稍加练习，任何人都可以学习如何将关系性拼图拼凑在一起。</p> <p>在本章中，我们研究了适用于函数式编程的几个数学概念，以及它们如何使我们在数据之间建立关系。 接下来，我们将探讨JavaScript中的递归和其他高级主题。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/halldwang/natpagle/edit/master/docs/book/chapter-fifth.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">12/31/2019, 12:06:56 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/natpagle/book/chapter-fourth.html" class="prev">第四章：JavaScript中的函数式编程实现</a></span> <span class="next"><a href="/natpagle/book/chapter-sixth.html">第六章：JavaScript中的高级函数和陷阱话题</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/natpagle/assets/js/app.b21d4d52.js" defer></script><script src="/natpagle/assets/js/2.793adf42.js" defer></script><script src="/natpagle/assets/js/7.e166f63b.js" defer></script>
    <script type="text/javascript">
     var _mtac = {};
     (function() {
       var mta = document.createElement("script");
       mta.src = "//pingjs.qq.com/h5/stats.js?v2.0.4";
       mta.setAttribute("name", "MTAH5");
       mta.setAttribute("sid", "500706003");
       var s = document.getElementsByTagName("script")[0];
       s.parentNode.insertBefore(mta, s);
     })();
    </script>
  </body>
</html>
